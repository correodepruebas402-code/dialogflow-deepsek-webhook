'use strict';

const express = require('express');
const axios = require('axios');
const { WebhookClient } = require('dialogflow-fulfillment');
require('dotenv').config();

const app = express();
app.use(express.json());

const deepseekApiKey = process.env.DEEPSEEK_API_KEY;
const deepseekApiUrl = 'https://api.deepseek.com/v1/chat/completions';

console.log(`‚úÖ API Key configurada: ${deepseekApiKey ? 'S√ç' : 'NO'}`);

const knowledgeBaseContext = `
Eres un asistente virtual experto y amigable de la tienda AmericanStor Online. Responde de manera clara, concisa y natural usando √∫nicamente la siguiente informaci√≥n. Siempre responde como un vendedor experto y entusiasta.

**AmericanStor Online:**
- Tienda 100% online de ropa americana original para hombre
- Productos: Ropa (camisetas, buzos, gorras) y perfumes
- Ropa 100% original importada de EE.UU.
- Contacto: WhatsApp e Instagram @americanstor.online
- Web: https://americanstor.online/

**CAT√ÅLOGO DE PERFUMES:**

**Perfumes Originales para Hombre:**
- Dior Sauvage (fresco, c√≠trico, amaderado) - Muy popular
- Hugo Boss Bottled (elegante, frutal, masculino)
- Calvin Klein CK One (unisex, c√≠trico puro, fresco)
- Versace Eros (intenso, oriental, seductor)
- Armani Code (sofisticado, especiado, nocturno)
- Paco Rabanne 1 Million (dorado, especiado, llamativo)

**Perfumes Originales para Mujer:**
- Chanel Coco Mademoiselle (elegante, oriental, sofisticado)
- Victoria's Secret (variedad: Bombshell, Love, Pure Seduction)
- Marc Jacobs Daisy (floral, fresco, juvenil)
- Carolina Herrera Good Girl (dual, elegante, moderno)

**Perfumes 1.1 (R√©plicas Alta Calidad):**
- Versiones 1.1 de TODAS las marcas mencionadas
- Duraci√≥n: 6-10 horas (excelente calidad)
- Mismas notas olfativas que los originales
- Precio mucho m√°s accesible

**TIPOS DE FRAGANCIAS por categor√≠a:**
- **C√≠tricas/Frescas:** Dior Sauvage, CK One (energizantes, d√≠a, verano)
- **Frutales:** Hugo Boss, Victoria's Secret Bombshell (dulces, juveniles)
- **Orientales/Intensas:** Versace Eros, Chanel Coco (sensuales, noche)
- **Florales:** Marc Jacobs Daisy, Carolina Herrera (delicadas, femeninas)
- **Amaderadas:** Dior Sauvage base, Armani Code (masculinas, elegantes)
- **Especiadas:** Paco Rabanne 1 Million, Armani Code (llamativas, invierno)

**Ropa Americana Original:**
- Camisetas, buzos, gorras de marcas reconocidas (Nike, Adidas, Supreme, etc.)
- Tallas americanas: S, M, L, XL
- 100% original importada de Estados Unidos

**Informaci√≥n Comercial:**
- **Env√≠os:** Toda Colombia, Inter Rapid√≠simo/Servientrega, $10.000-$15.000, 1-5 d√≠as
- **Pagos:** Nequi, Daviplata, Bancolombia, contra entrega, tarjetas
- **Cambios:** 5 d√≠as, producto sin uso con etiquetas
- **Garant√≠a:** Productos 100% originales

INSTRUCCIONES DE RESPUESTA:
- Siempre s√© entusiasta y conocedor
- Si preguntan por tipos espec√≠ficos, menciona 2-3 opciones concretas
- Incluye tanto originales como r√©plicas 1.1 como opciones
- Si no tienes info espec√≠fica de una marca: "Para confirmar esa referencia espec√≠fica, escr√≠beme al WhatsApp"
- Termina con llamado a la acci√≥n (WhatsApp, Instagram o web)
`;

// Sistema h√≠brido: Respuestas inteligentes instant√°neas + Deepseek como respaldo
function getIntelligentResponse(query) {
    const queryLower = query.toLowerCase();
    
    // 1. SALUDOS
    if (/^(hola|hello|hi|buenas|buenos|saludos|que tal|hey)/i.test(query.trim())) {
        return '¬°Hola! üòä Bienvenido a AmericanStor Online. Somos especialistas en ropa americana original y perfumes de las mejores marcas. ¬øEn qu√© puedo ayudarte hoy?';
    }
    
    // 2. PERFUMES C√çTRICOS/FRESCOS - Respuesta espec√≠fica
    if (queryLower.includes('citrico') || queryLower.includes('citricos') || (queryLower.includes('fresco') && queryLower.includes('perfume'))) {
        return '¬°Excelente elecci√≥n! üçã En perfumes c√≠tricos/frescos tenemos:\n\n‚Ä¢ **Dior Sauvage** - C√≠trico-amaderado, muy fresco y masculino\n‚Ä¢ **Calvin Klein CK One** - C√≠trico puro, unisex, s√∫per refrescante\n\nAmbos disponibles en versi√≥n **original** y **r√©plica 1.1** (6-10h duraci√≥n). Para precios y disponibilidad, escr√≠beme al WhatsApp üì±';
    }
    
    // 3. PERFUMES POR G√âNERO
    if (queryLower.includes('perfume') && queryLower.includes('hombre')) {
        return '¬°Perfecto! üí™ Para hombre tenemos excelentes opciones:\n\n‚Ä¢ **Dior Sauvage** (fresco, c√≠trico)\n‚Ä¢ **Versace Eros** (intenso, seductor)\n‚Ä¢ **Hugo Boss Bottled** (elegante, frutal)\n‚Ä¢ **Armani Code** (sofisticado, nocturno)\n\nTodos disponibles originales y r√©plicas 1.1. ¬øTe interesa alguno en particular? Escr√≠beme al WhatsApp para precios üì±';
    }
    
    if (queryLower.includes('perfume') && (queryLower.includes('mujer') || queryLower.includes('dama'))) {
        return '¬°Hermoso! ‚ú® Para mujer tenemos:\n\n‚Ä¢ **Chanel Coco Mademoiselle** (elegante, sofisticado)\n‚Ä¢ **Victoria\'s Secret** (Bombshell, Love, Pure Seduction)\n‚Ä¢ **Marc Jacobs Daisy** (floral, juvenil)\n‚Ä¢ **Carolina Herrera Good Girl** (moderno, elegante)\n\nOriginales y r√©plicas 1.1 disponibles. ¬øCu√°l te llama la atenci√≥n? Escr√≠beme al WhatsApp üì±';
    }
    
    // 4. MARCAS ESPEC√çFICAS
    if (queryLower.includes('dior')) {
        return '¬°Dior Sauvage! üî• Uno de nuestros m√°s vendidos. Es fresco, c√≠trico con base amaderada - perfecto para cualquier ocasi√≥n. Disponible:\n\n‚Ä¢ **Original importado** (m√°xima calidad)\n‚Ä¢ **R√©plica 1.1** (6-10h duraci√≥n, precio accesible)\n\nPara precios actuales y disponibilidad, escr√≠beme al WhatsApp üì±';
    }
    
    if (queryLower.includes('versace')) {
        return '¬°Versace Eros! ‚ö° Perfume intenso y seductor, perfecto para la noche. Disponible en:\n\n‚Ä¢ **Original importado**\n‚Ä¢ **R√©plica 1.1** (excelente calidad)\n\nTambi√©n manejamos otras fragancias Versace. Para cat√°logo completo, WhatsApp üì±';
    }
    
    // 5. ROPA
    if (queryLower.includes('ropa') || queryLower.includes('camisa') || queryLower.includes('buzo') || queryLower.includes('gorra')) {
        return '¬°Ropa americana original! üëï Importamos directamente de EE.UU.:\n\n‚Ä¢ **Camisetas** (Nike, Adidas, Supreme, etc.)\n‚Ä¢ **Buzos** de marcas reconocidas\n‚Ä¢ **Gorras** originales\n‚Ä¢ **Tallas:** S, M, L, XL\n\nTodo 100% original con etiquetas. Ver cat√°logo: https://americanstor.online/ o WhatsApp üì±';
    }
    
    // 6. TALLAS
    if (queryLower.includes('talla')) {
        return 'Manejamos **tallas americanas**: S, M, L, XL üìè\n\nTe recomiendo revisar nuestra gu√≠a de tallas en https://americanstor.online/ o env√≠ame tus medidas al WhatsApp y te ayudo a encontrar tu talla perfecta üì±';
    }
    
    // 7. ENV√çOS
    if (queryLower.includes('envio') || queryLower.includes('entrega')) {
        return 'üì¶ **Env√≠os a toda Colombia:**\n\n‚Ä¢ Transportadoras: Inter Rapid√≠simo/Servientrega\n‚Ä¢ Costo: $10.000 - $15.000\n‚Ä¢ Tiempo: 1-3 d√≠as ciudades principales, hasta 5 d√≠as otras zonas\n\n¬øA qu√© ciudad necesitas el env√≠o? Te confirmo el tiempo exacto por WhatsApp üì±';
    }
    
    // 8. PAGOS
    if (queryLower.includes('pago') || queryLower.includes('precio')) {
        return 'üí≥ **Formas de pago:**\n\n‚Ä¢ Transferencias: Nequi, Daviplata, Bancolombia\n‚Ä¢ Contra entrega (ciudades disponibles)\n‚Ä¢ Tarjetas d√©bito/cr√©dito\n\nPara precios espec√≠ficos de productos, escr√≠beme al WhatsApp con lo que te interesa üì±';
    }
    
    // 9. PERFUMES GENERALES
    if (queryLower.includes('perfume') && !queryLower.includes('tipo') && !queryLower.includes('cual')) {
        return '¬°Perfumes! ‚ú® Somos especialistas con amplio cat√°logo:\n\nüî∏ **Originales importados** de las mejores marcas\nüî∏ **R√©plicas 1.1** (alta calidad, 6-10h duraci√≥n)\n\nPara hombre y mujer. ¬øBuscas algo espec√≠fico o prefieres ver el cat√°logo completo? WhatsApp üì±';
    }
    
    // 10. CONTACTO/INFO GENERAL
    if (queryLower.includes('contacto') || queryLower.includes('whatsapp') || queryLower.includes('instagram') || queryLower.includes('info')) {
        return 'üìû **Cont√°ctanos:**\n\n‚Ä¢ WhatsApp (atenci√≥n personalizada)\n‚Ä¢ Instagram: @americanstor.online\n‚Ä¢ Web: https://americanstor.online/\n\n¬°Estamos aqu√≠ para ayudarte! üòä';
    }
    
    return null; // Si no hay respuesta inteligente, ir a Deepseek
}

async function handleQuery(agent) {
    const userQuery = agent.query;
    const intentName = agent.intent || 'Unknown';
    
    console.log(`üìù Intent: ${intentName} | Consulta: "${userQuery}"`);

    // 1. PRIMER INTENTO: Respuesta inteligente instant√°nea
    const intelligentResponse = getIntelligentResponse(userQuery);
    if (intelligentResponse) {
        console.log(`‚ö° Respuesta inteligente aplicada`);
        agent.add(intelligentResponse);
        return;
    }

    // 2. SEGUNDO INTENTO: Deepseek para consultas complejas
    if (!deepseekApiKey) {
        console.log('‚ùå API Key no configurada, usando fallback');
        agent.add('Gracias por contactar AmericanStor Online. Para informaci√≥n detallada sobre nuestros productos, escr√≠beme al WhatsApp o Instagram @americanstor.online üì±');
        return;
    }

    try {
        console.log('üöÄ Consultando Deepseek...');
        
        const apiResponse = await axios.post(deepseekApiUrl, {
            model: 'deepseek-chat',
            messages: [
                { role: 'system', content: knowledgeBaseContext },
                { role: 'user', content: userQuery }
            ],
            max_tokens: 200,
            temperature: 0.3,
            top_p: 0.9
        }, {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${deepseekApiKey}`
            },
            timeout: 3000
        });

        if (apiResponse.data?.choices?.[0]?.message?.content) {
            const botResponse = apiResponse.data.choices[0].message.content.trim();
            console.log(`‚úÖ Deepseek respondi√≥`);
            agent.add(botResponse);
        } else {
            throw new Error('Empty response from Deepseek');
        }

    } catch (error) {
        console.error(`‚ùå Error Deepseek: ${error.message}`);
        
        // 3. TERCER INTENTO: Fallback inteligente
        const fallbackResponse = getSmartFallback(userQuery);
        console.log(`üîÑ Usando fallback inteligente`);
        agent.add(fallbackResponse);
    }
}

function getSmartFallback(query) {
    const queryLower = query.toLowerCase();
    
    if (queryLower.includes('perfume')) {
        return 'Tenemos excelente variedad en perfumes originales e importados y r√©plicas 1.1 de alta calidad. Para informaci√≥n espec√≠fica sobre la referencia que buscas, escr√≠beme al WhatsApp donde te puedo mostrar disponibilidad y precios actuales üì±';
    }
    
    if (queryLower.includes('ropa')) {
        return 'Especialistas en ropa americana original importada de EE.UU. Para ver nuestro cat√°logo completo y tallas disponibles: https://americanstor.online/ o WhatsApp üì±';
    }
    
    return 'Gracias por contactar AmericanStor Online üòä Para brindarte la informaci√≥n m√°s precisa sobre tu consulta, escr√≠beme al WhatsApp o s√≠guenos en Instagram @americanstor.online üì±';
}

// Webhook
app.post('/webhook', (request, response) => {
    console.log('üîî Webhook recibido');
    const agent = new WebhookClient({ request, response });
    
    let intentMap = new Map();
    // Todos los intents van a la misma funci√≥n inteligente
    intentMap.set('Default Fallback Intent', handleQuery);
    intentMap.set('Consulta_Categorias', handleQuery);
    intentMap.set('Envio_sin_cobertura', handleQuery);
    intentMap.set('Envios_info', handleQuery);
    intentMap.set('Perfumes_Consulta', handleQuery);
    intentMap.set('Consulta_Tallas', handleQuery);
    intentMap.set('Consulta_Pagos', handleQuery);
    intentMap.set('Saludos', handleQuery);

    agent.handleRequest(intentMap);
});

// Health check
app.get('/health', async (req, res) => {
    let deepseekStatus = 'No configurada';
    
    if (deepseekApiKey) {
        try {
            const startTime = Date.now();
            await axios.post(deepseekApiUrl, {
                model: 'deepseek-chat',
                messages: [{ role: 'user', content: 'Test' }],
                max_tokens: 5
            }, {
                headers: {
                    'Authorization': `Bearer ${deepseekApiKey}`,
                    'Content-Type': 'application/json'
                },
                timeout: 2000
            });
            
            const latency = Date.now() - startTime;
            deepseekStatus = `OK (${latency}ms)`;
        } catch (error) {
            deepseekStatus = `Error: ${error.message}`;
        }
    }
    
    res.json({ 
        status: 'OK',
        timestamp: new Date().toISOString(),
        deepseek: deepseekStatus,
        intelligentResponses: 'Activadas',
        fallbackSystem: 'Triple capa'
    });
});

const port = process.env.PORT || 3000;
app.listen(port, () => {
    console.log(`üöÄ AmericanStor Bot optimizado en puerto ${port}`);
    console.log(`‚ö° Sistema h√≠brido: Respuestas inteligentes + Deepseek + Fallback`);
    console.log(`üéØ Cobertura: 100% de consultas con respuesta natural`);
});
